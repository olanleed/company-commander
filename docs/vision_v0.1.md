# 視界・FoW仕様 v0.1

---

## 0. 全体方針

**FoWは「地形の霧」ではなく「敵情（Intel）の霧」を主役にする（v0.1確定）**

| 項目 | 扱い |
|------|------|
| 背景地図（PNG）と拠点位置 | 常に見える（現代軍の作戦地図なので） |
| 隠すもの | 敵ユニット情報（存在・位置・種別・確度） |
| 可視範囲の影 | 必要ならデバッグ/演出として追加できるが、v0.1必須ではない |

> これで実装が軽く、「現実地図っぽい俯瞰表示」とも整合する。

---

## 1. 用語

| 用語 | 意味 |
|------|------|
| **LoS（Line of Sight）** | 観測・直射射撃のための「見通し線」 |
| **Concealment（隠蔽）** | 見えにくさ（＝発見距離が縮む） |
| **Cover（遮蔽）** | 当たりにくさ／被害が減る（＝被害・抑圧が減る） |
| **Hard Block** | 視線が完全に遮られる（幾何学的に遮断） |
| **Soft Occlusion** | 完全遮断ではないが、距離や濃さに応じて見えにくくなる（森林・煙など） |

---

## 2. 視点モデル

### 2.1 視点単位

#### TeamVision（陣営共有視界）

プレイヤーUIが参照するのはこれ。

```
TeamVision = union( comms_connected な味方要素のセンサー )
```

#### LocalVision（要素ローカル）※任意

- 通信断実装時の拡張用
- v0.1では `comms_connected = true` 前提で動かしてよい

### 2.2 "見える"の定義

味方センサーが敵要素に対して次を満たすと「視認エビデンス」が発生：

| 条件 | 説明 |
|------|------|
| 距離条件 | `distance <= D_eff` |
| LoS条件 | LoSブロック判定（HardBlock＋煙透過など） |

このエビデンスが **Contact（接触情報）** を更新し、CONF/SUS/LOSTが決まる。

---

## 3. LoS判定（ブロック仕様）

### 3.1 LoSの分類

LoS判定は **「Hard Block」→「Soft Occlusion」→「見える」** の順で評価。

| 分類 | 効果 |
|------|------|
| **HardBlocked** | 観測・直射射撃とも不可 |
| **SoftOccluded** | 見えるが性能が落ちる（発見距離・命中・同定が悪化） |
| **Clear** | 遮りなし（ただし隠蔽/遮蔽/煙で係数は掛かる） |

### 3.2 Hard Block（完全遮断）にする地物

| 地物 | ソース |
|------|--------|
| **建物ブロック**（BUILDING / URBAN_BLOCK） | HardBlockポリゴン |
| **CLIFF**（絶壁） | BaseTerrain=CLIFF か、崖線ポリゴン |

**ルール：**

| 判定 | Hard Blockを横切ったら |
|------|----------------------|
| 観測LoS | **観測不可** |
| 直射射撃LoS | **直射不可** |
| 間接射撃 | 影響なし（ただし観測・修正には影響） |

### 3.3 Soft Occlusion（厚みで見えにくくする）

v0.1では **FOREST** と **SMOKE** を Soft Occlusion とする。

#### 森林オクルージョン

LoS線分が森林ポリゴンと交差する「森林内通過距離」を `L_forest(m)` とする。

**森林透過率：**

```
T_forest = exp( -L_forest / 60 )
```

**実用ルール：**

| 条件 | 判定 |
|------|------|
| `T_forest < 0.10` | **森林で実質ブロック**（観測不可・直射不可） |
| それ以外 | SoftOccluded として扱い、`T_forest` を後段の係数に使う |

**目安：**
- 森林内を約140m以上見通すのはほぼ無理（0.1以下）
- 森林縁の短距離戦は成立（30mなら T≈0.61）

#### 最終LoS透過率

Hard Blockがない場合：

```
T_LoS = T_forest × T_smoke
```

| T_LoS | 判定 |
|-------|------|
| `< 0.10` | **実質ブロック扱い**（視覚観測・直射不可） |
| `0.10 ≤ T_LoS < 1.0` | SoftOccluded |
| `= 1.0` | Clear |

### 3.4 ユニットのサイズ

中隊/要素は点ではなく「占有半径」を持つ（例：INF 12m, VEH 15m 等）。

**v0.1のサンプル点：**
- **中心＋左右（計3点）**
- どれか1本でも Clear/SoftOccluded が成立したら「見える」
- `T_LoS` は3本の **最大を採用**

---

## 4. 発見・同定（Detection / Classification）仕様

### 4.1 段階

| 段階 | 意味 |
|------|------|
| **Detection（発見）** | 敵がいることを知る（SUSでも良い） |
| **Classification（同定）** | 種類（歩兵/車両/兵科など）を確定してCONFへ |
| **Tracking（追跡）** | 見失っても推定を維持（SUSの生成） |

### 4.2 発見距離の計算（基準式）

各要素（Observer）が持つ「基準発見距離」`R_base` は、ユニット仕様から来る前提。
そこに係数を掛けて **実効発見距離** `R_eff` を作る。

```
R_eff = R_base × M_target_terrain × M_target_activity × M_observer_state × T_LoS
```

| 係数 | 意味 |
|------|------|
| `T_LoS` | 透過率（0〜1） |
| `M_target_terrain` | 目標位置の隠蔽係数（地形） |
| `M_target_activity` | 目標の活動で目立つ係数 |
| `M_observer_state` | 観測側の状態（抑圧など）で見落とす係数 |

### 4.3 発見距離係数（Concealment係数表：M_target_terrain）

「目標がその地形にいると、どれだけ見つけにくいか」を表す。小さいほど見つけにくい。

| BaseTerrain（目標位置） | M_target_terrain |
|------------------------|------------------|
| OPEN | 1.00 |
| ROUGH | 0.90 |
| FOREST | 0.60 |
| URBAN | 0.70 |
| MARSH | 0.80 |
| WATER_SHALLOW | 1.00 |
| WATER_DEEP | 1.00 |
| CLIFF | 0.85 |

### 4.4 目標の活動係数（M_target_activity）

| 目標状態 | M_target_activity |
|---------|------------------|
| 静止・非射撃 | 1.00 |
| 移動中 | 1.15（FOOT）/ 1.25（VEH） |
| 射撃中（直射） | 1.30（FOOT）/ 1.40（VEH） |
| 間接射撃実行中（WEAP） | 1.50 |

### 4.5 観測側の状態係数（M_observer_state）

| 観測側の抑圧状態 | M_observer_state |
|----------------|------------------|
| Normal（Suppression < 40） | 1.00 |
| Suppressed（40–69） | 0.75 |
| Pinned（70–89） | 0.40 |
| Broken（≥90） | 0.20 |

### 4.6 発見の成立条件

- 目標までの距離 `D` が `D ≤ R_eff` なら **Detection成功**
- ただし `T_LoS < 0.10` の場合は **視覚発見不可**（距離に関係なく）

### 4.7 同定（Classification）

各目標に対して `classify_progress` を持ち、見えている間増える。

**1秒あたりの同定進捗：**

```
dP/dt = 1 / (ClassifyTime_base × K)
K = 1 / max(T_LoS, 0.25)
```

> 煙や森林でTが下がると同定が遅くなるが、無限遅延は避ける。

`classify_progress >= 1.0` で **CONF化**

---

## 5. 遮蔽（Cover）係数仕様

### 5.1 遮蔽は「被害」と「抑圧」に効く

各攻撃は2つの効果を持つ前提：
- **Strength減少**（Lethality）
- **Suppression増加**

遮蔽はこれらを減らす係数として扱う。

### 5.2 地形別遮蔽係数（Cover係数表）

小さいほど防御が強い（被害・抑圧が減る）。

#### 直射（Direct Fire）への係数

| BaseTerrain（被射撃側位置） | M_cover_DF |
|---------------------------|-----------|
| OPEN | 1.00 |
| ROUGH | 0.85 |
| FOREST | 0.70 |
| URBAN | 0.60 |
| MARSH | 0.90 |
| WATER_SHALLOW | 1.00 |
| CLIFF | 0.80 |

#### 間接（Indirect Fire：榴弾片）への係数

| BaseTerrain | M_cover_IF |
|-------------|-----------|
| OPEN | 1.00 |
| ROUGH | 0.95 |
| FOREST | 0.85 |
| URBAN | 0.80 |
| MARSH | 0.95 |
| WATER_SHALLOW | 1.00 |
| CLIFF | 0.90 |

### 5.3 陣地化（Dig-in）による追加係数

陣地化が100%完了している場合、さらに掛ける：

| 火力種別 | 係数 |
|---------|------|
| 直射 | × 0.70 |
| 間接 | × 0.90 |

進捗が `EntrenchProgress` のときは線形補間：

```
M_entrench_DF = lerp(1.00, 0.70, EntrenchProgress/100)
M_entrench_IF = lerp(1.00, 0.90, EntrenchProgress/100)
```

### 5.4 分散モードによる間接耐性

| 分散モード | M_dispersion_IF |
|-----------|----------------|
| Column | 1.15 |
| Deployed | 1.00 |
| Dispersed | 0.85 |

**最終の間接係数：**

```
M_total_IF = M_cover_IF × M_entrench_IF × M_dispersion_IF
```

### 5.5 最終ダメージ/抑圧への適用

**直射：**

```
Damage *= M_cover_DF × M_entrench_DF × M_smoke_fire
Suppression += base_supp × M_cover_DF × M_entrench_DF × M_smoke_fire
```

**間接：**

```
Damage *= M_total_IF
Suppression += base_supp × M_total_IF
```

---

## 6. 煙幕（Smoke）仕様

### 6.1 SmokeScreenエンティティ

煙幕は「視線を完全遮断しないが、視覚性能を落とすSoft Occlusion」。

**各煙幕が持つ属性：**

```
center (x, y)
radius_m
density (0..1)           # 現在密度
density_max (0..1)       # 最大密度（通常1.0）
rise_time_sec            # 立ち上がり
sustain_time_sec         # 維持
fade_time_sec            # 消散
type                     # STANDARD（v0.1はこれのみ）
```

**時間プロファイル（v0.1固定値）：**

| フェーズ | 時間 | density |
|---------|------|---------|
| 立ち上がり | 10秒 | 0 → 1 |
| 維持 | 60秒 | 1 |
| 消散 | 20秒 | 1 → 0 |

### 6.2 煙による透過率（T_smoke）

LoS線分が煙円と交差する「煙内通過距離」を `L_smoke(m)` とする。
煙が複数ある場合は合算する。

**煙の光学深度：**

```
τ_smoke = Σ ( density_i × L_smoke_i / 40 )
```

**煙透過率：**

```
T_smoke = exp( -τ_smoke )
```

**実用ルール：**

| 条件 | 判定 |
|------|------|
| `T_smoke < 0.10` | **実質ブロック**（視覚観測不可・直射不可） |
| それ以外 | SoftOccluded |

### 6.3 煙が「直射火力」に与える影響（M_smoke_fire）

煙は物理遮蔽ではないので、「命中・照準が悪化する」扱いにする。

**直射の火力効果に掛ける係数：**

```
M_smoke_fire = clamp(T_smoke, 0.25, 1.00)
```

> 目標が薄い煙越しでも"多少は当たる"が、濃い煙ではかなり弱くなる（0.25下限）。

**間接火力への直接減衰は無し**（煙は破片を止めない）。

---

## 7. 計算タイミング（ハイブリッド方式）

**結論：「状態遷移は毎tick」＋「視認チェックは間引き＋イベント」**

### 7.1 実行頻度

| 頻度 | 処理内容 |
|------|---------|
| **10Hz（毎tick）** | Contactの経過時間・状態遷移（CONF→SUS→LOST）、推定位置の誤差成長 |
| **5Hz（0.2秒ごと）** | 視認チェック（LoS＋距離判定） |

```
VISION_SCAN_INTERVAL_TICKS = 2
```

### 7.2 イベント駆動の"前倒し"トリガ

次のイベントが起きたら、次tickで即スキャン（間引きを無視）：

| イベント | 説明 |
|---------|------|
| スポーン・死亡 | 敵/味方の出現・消滅 |
| 煙幕の生成/消滅 | LoSが変わる |
| HardBlockの生成/消滅 | 建物破壊等 |
| 大きい移動 | 要素が前回スキャン位置から10m以上動いた |

実装上は `vision_dirty = true` を立てて、次tickでスキャンを走らせる。

---

## 8. CONF→SUS→LOST の遷移条件

### 8.1 ContactRecord（接触情報）の保持

陣営ごとに、敵要素IDをキーに以下を保持：

| フィールド | 説明 |
|-----------|------|
| `state` | CONF / SUS / LOST |
| `last_visible_tick` | 最後に視認できたtick |
| `pos_est_m` | 推定位置（CONFは実位置、SUS/LOSTは推定） |
| `vel_est_mps` | 推定速度（最後にCONFだった時の速度） |
| `pos_error_m` | 位置誤差半径（SUS/LOSTで成長） |
| `type_hint` | ユニット種別ヒント |
| `visible_streak_scans` | 連続視認回数 |

### 8.2 取得（Acquire）条件：CONF確定ルール

| パラメータ | 値 |
|-----------|-----|
| スキャン頻度 | 5Hz（0.2秒） |
| CONF確定に必要な連続視認回数 | 2回 |

```
CONF_ACQUIRE_STREAK = 2（= 0.4秒）
```

### 8.3 状態遷移

| 遷移 | 条件 | 時間 |
|------|------|------|
| → CONF | 連続視認2回 | 0.4秒 |
| CONF → SUS | 視認なし | 3.0秒（30tick） |
| SUS → LOST | 視認なし | 15.0秒（150tick） |
| LOST → 忘却 | 視認なし | 60秒（600tick） |

### 8.4 位置誤差（SUS/LOST）の成長

```
ERROR_GROWTH_MPS = 6.0（v0.1既定）
ERROR_MAX_M = 300（上限）
```

**更新（毎tick）：**

```
pos_error_m = min(ERROR_MAX_M, pos_error_m + ERROR_GROWTH_MPS * dt)
pos_est_m = pos_est_m + vel_est_mps * dt
```

**CONFに戻ったら：** `pos_error_m = 0`

---

## 9. ミニマップへの反映

### 9.1 ミニマップに描くレイヤ（順序）

1. 地形背景（固定画像 or 簡易カラー）
2. CP（常に表示、支配色も常に表示）
3. 味方ユニット（常時）
4. 敵コンタクト（CONF/SUS/LOSTで表示を変える）
5. ピン/アラート

### 9.2 敵コンタクトの描画ルール

| state | アイコン | 位置 | 誤差円 | クリック |
|-------|---------|------|--------|---------|
| CONF | 実アイコン | 実位置 | なし | 可 |
| SUS | ?/菱形 | 推定位置 | あり | 可 |
| LOST | 薄いマーカー | 推定位置 | なし推奨 | 不可 |

---

## 10. 早見表

### 10.1 隠蔽係数（M_target_terrain）

| 地形 | 係数 |
|------|------|
| OPEN | 1.00 |
| ROUGH | 0.90 |
| FOREST | 0.60 |
| URBAN | 0.70 |
| MARSH | 0.80 |

### 10.2 遮蔽係数（M_cover）

| 地形 | 直射 | 間接 |
|------|------|------|
| OPEN | 1.00 | 1.00 |
| ROUGH | 0.85 | 0.95 |
| FOREST | 0.70 | 0.85 |
| URBAN | 0.60 | 0.80 |
| MARSH | 0.90 | 0.95 |

### 10.3 陣地化係数

| 火力 | 完了時係数 |
|------|-----------|
| 直射 | × 0.70 |
| 間接 | × 0.90 |

### 10.4 状態遷移タイミング

| 遷移 | 時間 |
|------|------|
| → CONF | 0.4秒（連続2回視認） |
| CONF → SUS | 3.0秒 |
| SUS → LOST | 15.0秒 |
| LOST → 忘却 | 60秒 |

### 10.5 定数一覧

```
VISION_SCAN_INTERVAL_TICKS = 2
CONF_ACQUIRE_STREAK = 2
T_CONF_TO_SUS_TICKS = 30
T_SUS_TO_LOST_TICKS = 150
T_LOST_TO_FORGET_TICKS = 600
ERROR_GROWTH_MPS = 6.0
ERROR_MAX_M = 300
```

### 10.6 調整ノブ

| パラメータ | 基準値 | 効果 |
|-----------|--------|------|
| 森林透過の基準距離 | **60m** | 小さくすると森が"壁"になる |
| 煙の基準距離 | **40m** | 小さくすると煙が強くなる |
| 実質ブロック閾値 | **T < 0.10** | 閾値を上げるとSoft Occlusionが厳しくなる |
| URBANの隠蔽係数 | **0.70** | 市街が強すぎる/弱すぎるの調整点 |
| Dig-in係数 | DF×0.70 / IF×0.90 | 陣地の硬さ調整 |
| 分散IF係数 | **0.85** | 間接の理不尽さを抑える |

---

## 11. UI表示：視界範囲円の読み方

### 11.1 TacticalOverlayの視界円

ユニットを選択すると表示される視界円は、以下を表す：

| 円 | 色 | 意味 |
|---|---|---|
| **実線円** | 青（半透明塗り） | 静止している敵をOPEN地形で発見できる最大距離 |
| **破線円** | 青（薄い破線） | 移動中の敵（車両）をOPEN地形で発見できる最大距離（+25%） |

### 11.2 視界円と実際の発見距離の関係

**重要：視界円は「最良条件」を表示している**

実際の発見距離 `R_eff` は以下の式で計算される：

```
R_eff = R_base × M_target_terrain × M_target_activity × M_observer_state
```

視界円の表示は `M_target_terrain = 1.0`（OPEN地形）、`M_target_activity = 1.0`（静止）または`1.25`（移動）を仮定している。

### 11.3 視界円の外で敵が見えるケース

**破線円の中（実線円の外）で敵が見える場合：**
- 敵が**移動中**である（`M_target_activity = 1.15〜1.25`）
- 移動中の車両は+25%、歩兵は+15%で発見距離が伸びる

### 11.4 視界円の中で敵が見えないケース

**実線円の中にいるのに敵が見えない場合：**

| 原因 | 係数 | 効果 |
|---|---|---|
| 敵がFOREST地形 | `M_terrain = 0.60` | 発見距離が40%減少 |
| 敵がURBAN地形 | `M_terrain = 0.70` | 発見距離が30%減少 |
| 自分が抑圧されている | `M_observer = 0.75〜0.20` | 発見距離が25%〜80%減少 |
| LoSがブロックされている | `T_LoS < 0.10` | 発見不可 |

### 11.5 実践的な読み方

1. **実線円** = 「理想条件で静止敵が見える範囲」
2. **破線円** = 「理想条件で移動中の敵が見える範囲」
3. 地形や抑圧により、実際の発見距離はこれより**短くなる**ことがある
4. 敵が移動中なら、実線円の外でも**見える**ことがある
