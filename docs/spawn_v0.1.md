# 初期配置・スポーン仕様 v0.1

---

## A. 方式の選択（アーキテクチャ）

### A1. 基本は「個別購入」＋「テンプレ呼び出し」

| 方式 | 説明 |
|------|------|
| **個別購入** | いつでも1ユニット（中隊）ずつ購入→スポーン指定 |
| **テンプレ呼び出し** | 保存した「部隊セット（Opening / Reinforcement）」を1クリックで購入・割当（RP枠内で） |

> テンプレは"買い物を自動化するマクロ"。
> 結果として **初心者はテンプレで即プレイ可、熟練者は個別で最適化可** になる。

### A2. 「テンプレから一気に召喚」だけにしない理由

テンプレオンリーにすると：
- 相手の動きへの **適応（柔軟な増援）** が弱くなる
- テンプレ編集が実質デッキ構築になり、初期設計が重くなる

**テンプレは強制ではなく"高速化手段"** に留める。

---

## B. マッチ開始〜ゲーム開始までのフェーズ

### B1. フェーズを2つに分ける（確定）

| フェーズ | 説明 |
|---------|------|
| **Deployment Phase（配備フェーズ）** | シム停止（sim_speed=0）。購入、スポーン割当、初期ウェイポイント、Facing、防御扇形などを計画 |
| **Live Phase（戦闘フェーズ）** | 10Hzシム開始 |

#### Deployment Phaseの時間

| モード | 時間 |
|--------|------|
| シングル | 無制限 |
| マルチ | カウントダウン（例：45〜60秒） |

> 「開始直後に画面がスカスカ」「輸送枠2で最初の2個しか来ない」という体験を回避。

---

## 1. 初期配置（中隊の初期配置方法）

### 1.1 初期配置は「マップエディタで固定」＋「プレイヤーが割当」

| 決定事項 | 説明 |
|---------|------|
| ランダム配置 | しない（公平性と学習性が落ちる） |
| 初期配置要素 | マップ作者（エディタ）が固定で定義 |
| プレイヤー操作 | 配備フェーズで「どのユニットをどの入口に置くか」を選ぶ |

### 1.2 マップ側データ（必須）

#### (1) DeploymentRegion（陣営ごとの初期配備エリア：ポリゴン）

| 属性 | 説明 |
|------|------|
| 数 | Team Blue / Team Red それぞれに1つ以上 |
| 役割 | 初期スポーンの許可範囲、UIで「ここが安全圏」と一目で分かる |

#### (2) EntryPoints（初期配備用の入口点：2〜6点）

| 属性 | 説明 |
|------|------|
| 位置 | DeploymentRegionの内側（道路上推奨） |
| `allowed_mobility` | FOOT/WHEELED/TRACKED |
| `spawn_capacity` | 同時に置ける数、または最小間隔 |
| `default_facing` | デフォルトの向き |
| `tags` | 例：Left Lane / Center / Right Lane |

> "点"にしておくと、ドラッグ&ドロップで割当しやすく、衝突や重なりの制御が簡単。

### 1.3 初期スポーンの挙動（確定）

| ルール | 説明 |
|--------|------|
| 出現タイミング | Live開始時に **即時スポーン**（遅延なし） |
| 重なり回避 | スポーン時に小さなジッタ（数m）を入れてよい |
| 輸送枠 | 初期スポーンは `transport_slots` を **消費しない** |

> 初期スポーンが輸送枠を消費しない理由：
> - 開始直後が待ち時間になるのを防ぎ、ゲームテンポを守る
> - "現実的には既に集結済み"という解釈にできる

---

## 2. 増援スポーン（出現位置と条件）

### 2.1 増援の出現位置（2種類）

#### (A) Rear Entry（後方入口：常に使用可能）

| 属性 | 説明 |
|------|------|
| 位置 | 各陣営のマップ端／後方DeploymentRegion内のEntryPoints |
| 使用条件 | いつでも呼べる「本線」 |

#### (B) Forward Entry（前進入口：条件付き）

| 属性 | 説明 |
|------|------|
| 位置 | 支配下の拠点（CP）に紐づくArrival Points（拠点ごと2〜4個） |
| 使用条件 | 以下すべてを満たすとき |

**Forward Entry使用条件：**

1. その拠点が自陣営支配（占領済み）
2. コンテスト状態ではない（敵が近くにいない）
3. 司令・兵站の接続が成立（v0.1では簡略化してもOK）

> Forward Entryを入れると「コンクエストで前線を押し上げる＝補給線と増援口が前に出る」が成立し、基地建設無しでも"戦線運用"がゲームになる。

### 2.2 コンテスト判定（出現阻止ルール）

| 状況 | Forward Entry |
|------|--------------|
| 拠点がコンテスト（拠点半径内に敵がいる） | **使用不可** |
| Arrival Point半径 `R_block` 内に敵がいる | **使用不可** |

| パラメータ | 推奨値 |
|-----------|--------|
| `R_block` | 150〜200m |

> Rear Entryは原則ブロックしない（安全圏として扱う）。

### 2.3 増援の出現処理（キュー＋輸送枠）

#### 増援フロー

```
購入（RP消費）
    ↓
ReinforcementQueue に入る
    ↓
transport_slots（既定2枠）が空いたら InTransit
    ↓
ETA 経過でスポーン（指定Arrival Pointに出現）
    ↓
プレイヤーが事前に積んだ命令（Waypoints等）を実行開始
```

#### ETA（到着時間）v0.1

```
ETA = base_delay + extra_delay
```

| Entry種別 | base_delay |
|----------|------------|
| Rear Entry | 20s |
| Forward Entry | 15s（前進のメリット） |

| 条件 | extra_delay |
|------|-------------|
| 迂回や再割当 | +15s |

#### 到着直前にコンテスト化した場合

| 処理 | 説明 |
|------|------|
| 自動リルート | 最寄りのRear Entryへ振替 |
| ペナルティ | extra_delay += 15s |
| UI通知 | 「REROUTED」（ログ＋ミニマップピン） |

---

## 3. 試合開始時のRP初期値とユニット購入フロー

### 3.1 RP初期値の決め方

ユニットコストがまだ確定していないので、**"収入との比率"** で決める。

#### 決定：StartRPは「ベース収入の5分相当」を既定

```
StartRP = BaseIncomeRP_per_sec * 300
```

| 理由 | 説明 |
|------|------|
| 空っぽ回避 | 「最初から何もいない」を避ける |
| 出し切り防止 | 早期に全部出し切って終わり、にならない |
| スケーラブル | BaseIncomeを変えてもバランスが崩れにくい |

> 「3分」「7分」にするのはマッチテンポ調整ノブ。

### 3.2 購入フロー（個別購入）

1. Reinforcement Panelでユニットカード選択
2. クリックで購入（RP即時消費）
3. Spawn Point指定（Rear/Forwardのどれに出すか）
   - デフォルトは「最も安全で近い（目的地に近い）Spawn」を自動選択
4. 購入後、到着前でも命令をキューできる
   - 例：到着→道路移動→降車→Defend まで事前に積める

### 3.3 購入フロー（テンプレ召喚）

テンプレは2種類に分ける。

#### (A) Opening Template（配備フェーズ用）

| 用途 | 例 |
|------|-----|
| 開幕プラン | 機械化歩兵中隊＋戦車中隊＋迫撃中隊 |
| 操作 | 一括購入→入口へ自動割当→必要なら微調整 |

#### (B) Reinforcement Template（戦闘中用）

| 用途 | 例 |
|------|-----|
| 状況対応 | 「AT補強セット」「煙幕セット」「LOG補強セット」 |

#### 実行ルール（v0.1推奨）

**貪欲方式（Greedy）**：
- テンプレ内の優先順に、RPと在庫（将来）と輸送枠を満たす範囲で買えるだけ買う
- 結果をポップアップで要約（何を買えた/買えなかった）

> "一括を原子（全部買えないなら0）"にするとストレスが出やすいので、Greedyが扱いやすい。

---

## 4. 仕様サマリー

### 4.1 方式決定

| 基本方式 | 説明 |
|---------|------|
| 個別購入＋スポーン指定 | Wargame:RD型 |
| テンプレ一括購入 | 同じRP枠で、高速化手段として |

### 4.2 達成項目

| 項目 | 達成方法 |
|------|---------|
| **テンポ** | 開始直後から遊べる（Deployment Phase＋即時スポーン） |
| **認知負荷** | 買い物で忙殺されない（テンプレ） |
| **適応性** | 状況に応じて個別補強できる |
| **リアリティ** | 事前の任務編成＋必要時の増援要求 |

---

## 5. 早見表

### 5.1 フェーズ

| フェーズ | sim_speed | 操作 |
|---------|-----------|------|
| Deployment | 0 | 購入、配置、計画 |
| Live | 1〜4 | 戦闘 |

### 5.2 Entry種別

| Entry | 位置 | 使用条件 | base_delay |
|-------|------|---------|------------|
| Rear | マップ端・後方 | 常時 | 20s |
| Forward | 支配下CP | 占領済み＆非コンテスト | 15s |

### 5.3 増援フロー

```
購入 → Queue → InTransit（枠空き次第）→ ETA経過 → スポーン
```

### 5.4 テンプレ種別

| 種別 | 使用フェーズ | 用途 |
|------|-------------|------|
| Opening | Deployment | 開幕編成 |
| Reinforcement | Live | 状況対応増援 |

### 5.5 マップデータ要件

| データ | 内容 |
|--------|------|
| DeploymentRegion | 陣営別配備エリア（ポリゴン） |
| EntryPoints | 初期スポーン点（2〜6点/陣営） |
| ArrivalPoints | 拠点紐づき前進スポーン点 |

### 5.6 パラメータ

| パラメータ | v0.1既定値 |
|-----------|-----------|
| transport_slots | 2 |
| Rear base_delay | 20s |
| Forward base_delay | 15s |
| reroute extra_delay | +15s |
| R_block | 150〜200m |
| StartRP | BaseIncomeRP_per_sec × 300 |
