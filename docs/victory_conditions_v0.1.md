# 勝利条件仕様 v0.1

---

## 0. 勝利条件の優先順位

試合は以下のいずれかで終了する（上から判定）。

| 優先順 | 条件 | 結果 |
|--------|------|------|
| 1 | **降伏（Surrender）** | Victory by Surrender |
| 2 | **チケット0（Ticket Exhaustion）** | Victory by Ticket Exhaustion |
| 3 | **全滅（Operational Wipeout）** | Defeat by Operational Wipeout |
| 4 | **時間切れ（Time Limit）** | Victory by Time Decision / Draw |

---

## 1. チケット仕様

### 1.1 初期チケット

| 項目 | 値 |
|------|-----|
| 各陣営の初期チケット | **600** |

### 内部表現（決定論対策）

| 表現 | 説明 |
|------|------|
| `tickets_milli` | 例：600000で管理 |
| 表示 | 整数（600）に丸める |

> 10Hzで小数減算しても誤差が出にくい。

---

## 2. チケット減少ルール（拠点数による減少速度）

### 2.1 拠点（CP）の状態定義

各CPは常に以下のいずれかの状態：

| 状態 | 説明 |
|------|------|
| `CONTROLLED_BLUE` | Blueが保持 |
| `CONTROLLED_RED` | Redが保持 |
| `NEUTRAL` | 誰も保持していない |
| `CONTESTED` | 両軍が争っていて占領進捗が止まる |

**チケット計算でカウントするのは "CONTROLLEDのみ"**
- Neutral / Contested は どちらの保持数にも入れない

### 2.2 保持数と差分

```
N_blue = BlueがCONTROLLEDしているCP数 (0..5)
N_red  = RedがCONTROLLEDしているCP数 (0..5)
diff   = abs(N_blue - N_red)
```

### 2.3 チケットの「出血（bleed）」基本式

保持数が多い側が優勢で、**少ない側が出血**する。

| 条件 | 出血する側 |
|------|-----------|
| N_blue > N_red | Red |
| N_red > N_blue | Blue |
| N_blue == N_red | 出血なし |

**減少（連続時間）：**

```
dTickets/dt = -BleedRate(diff)  # 劣勢側のみ
```

### 2.4 BleedRateの具体式（テーブル確定）

単位：tickets / sec

| diff | 状況例（目安） | BleedRate(diff) |
|------|---------------|-----------------|
| 0 | 2–2–1 や 3–3（同数） | 0.00 |
| 1 | 2 vs 1（残りは中立/争奪） | 0.15 |
| 2 | 3 vs 1 | 0.35 |
| 3 | 4 vs 1 | 0.60 |
| 4 | 4 vs 0 | 0.90 |
| 5 | 5 vs 0 | 1.30 |

#### 実装メモ（10Hz）

```gdscript
# tickごとの減少
tickets_milli -= BleedRate(diff) * 1000 * dt
# dt = 0.1
# 例：diff=2なら、1tickあたり 0.35 * 1000 * 0.1 = 35 milliTickets 減る
```

### 2.5 チケット0の勝利条件

- どちらかの `tickets <= 0` になった時点で**即終了**
- 結果：**Victory by Ticket Exhaustion**

---

## 3. 全滅判定（壊滅閾値と"全滅"の条件）

### 3.1 ユニットの「壊滅」閾値（確定）

| 閾値 | 条件 |
|------|------|
| **壊滅（Combat Ineffective / CI）** | Strength ≤ 15（＝15%） |

#### CIの扱い（v0.1確定）

CIユニットはマップ上に残っていても：

| 扱い | 説明 |
|------|------|
| 戦力カウント | しない（全滅判定から除外） |
| 拠点制圧 | 参加できない（制圧力 0） |

> Strengthが回復して15を超える仕様にしない（損耗は戻らない）前提なら、CIは実質"戦場からの退場"扱い。

### 3.2 "全滅（Operational Wipeout）"の定義（確定）

次の条件を**すべて満たした場合**に敗北。

#### Wipeout条件

1. `CombatCapableCount == 0` が **連続 120秒** 続く
2. かつ、`ETA <= 120秒` の増援（戦力カウント対象）が **存在しない**

#### CombatCapableCountの定義

```
CombatCapableCount = counts_for_wipe == true かつ Strength > 15 のユニット数
```

#### counts_for_wipe（v0.1既定）

| 値 | ユニット種別 |
|----|-------------|
| `true` | INF / REC / VEH / TANK / WEAP |
| `false` | LOG / HQ（補給車両だけ隠して延命を防ぐため） |

#### 補足（実装が破綻しないための確定事項）

| ルール | 説明 |
|--------|------|
| 判定開始猶予 | Live Phase開始後 **60秒間** はWipeout判定を無効（初動の事故防止） |
| タイマーリセット | 120秒カウント中に戦力が1つでも出現（スポーン／到着）したらリセット |
| 増援到着予定 | 120秒以内に増援到着予定がある場合はタイマーを**停止**（v0.1推奨） |

- 結果：**Defeat by Operational Wipeout**

---

## 4. 時間制限（有無と判定方法）

### 4.1 時間制限の有無（v0.1既定）

| 項目 | 値 |
|------|-----|
| デフォルト | **30:00（1800秒）** |

#### 設定オプション（将来）

| 時間 | 説明 |
|------|------|
| 20:00 | 短時間戦 |
| 30:00 | 標準（既定） |
| 45:00 | 長時間戦 |
| 無制限 | 時間切れなし |

### 4.2 時間切れ時の勝敗判定（確定）

制限時間に達したら、以下の**優先順**で判定：

| 優先順 | 判定基準 | 結果 |
|--------|---------|------|
| 1 | チケットが多い陣営 | 勝ち |
| 2 | チケット同数なら、保持CP数が多い陣営 | 勝ち |
| 3 | それも同数なら、残存戦力（Combat Power）が多い陣営 | 勝ち |
| 4 | それも同数 | 引き分け |

#### 残存戦力（Combat Power）の定義

```
CombatPower = Σ clamp((Strength - 15) / 85, 0..1)
```

- 対象：`counts_for_wipe == true` のユニット
- Strength 15以下は0扱い
- Strength 100なら1.0

> 「生き残ったが壊滅状態の部隊」で引き分け延命ができない。

- 結果：**Victory by Time Decision** / **Draw**

---

## 5. 降伏（Surrender）仕様

### 5.1 仕様（確定）

| 項目 | 内容 |
|------|------|
| 場所 | メニュー（Esc）に Surrender を用意 |
| 効果 | 降伏が確定した瞬間に試合終了 |
| 勝者 | 相手：Victory by Surrender |
| 敗者 | 降伏側 |

### 5.2 誤操作対策（確定）

降伏は取り返しがつかないため、UI上は**二重安全**にする。

| 対策 | 説明 |
|------|------|
| ホールド確定 | Surrenderボタンは **2秒ホールド** で確定（進捗リング表示） |
| 最終確認 | ホールド完了後、ダイアログ：「Enterで確定 / Escでキャンセル」 |
| 取り消し不可 | 確定後はUndo不可 |

> 「押し間違い」「連打事故」をほぼ排除。

---

## 6. まとめ（v0.1決定事項）

### 6.1 チケット600の減少ルール

```
dTickets/dt = -BleedRate(diff)  # 劣勢側のみ
```

BleedRateはテーブルで確定。

### 6.2 全滅判定の閾値

| レベル | 閾値 |
|--------|------|
| ユニット壊滅 | Strength ≤ 15% |
| 陣営全滅 | 戦力カウント対象が0の状態が120秒継続＋増援も来ない |

### 6.3 時間制限

| 項目 | 値 |
|------|-----|
| デフォルト | 30分 |
| 時間切れ判定 | チケット → CP → 残存戦力 の順 |

### 6.4 降伏

- 実装する
- 相手が降伏したら即勝利
- 誤操作防止あり（ホールド＋確認ダイアログ）

---

## 7. 早見表

### 7.1 勝利条件優先順位

| 順位 | 条件 | 判定タイミング |
|------|------|---------------|
| 1 | Surrender | 即時 |
| 2 | Ticket Exhaustion | tickets <= 0 |
| 3 | Operational Wipeout | 120秒継続 |
| 4 | Time Limit | 制限時間到達 |

### 7.2 BleedRate表

| diff | rate (tickets/sec) |
|------|-------------------|
| 0 | 0.00 |
| 1 | 0.15 |
| 2 | 0.35 |
| 3 | 0.60 |
| 4 | 0.90 |
| 5 | 1.30 |

### 7.3 全滅判定パラメータ

| パラメータ | 値 |
|-----------|-----|
| CI閾値 | Strength ≤ 15 |
| Wipeout継続時間 | 120秒 |
| 判定開始猶予 | Live開始後60秒 |
| 増援猶予 | ETA ≤ 120秒 |

### 7.4 時間切れ判定順序

```
1. チケット比較
2. CP保持数比較
3. CombatPower比較
4. 引き分け
```

### 7.5 CP状態とチケット計算

| CP状態 | チケット計算に含める |
|--------|---------------------|
| CONTROLLED_BLUE | ○（Blueカウント） |
| CONTROLLED_RED | ○（Redカウント） |
| NEUTRAL | × |
| CONTESTED | × |
