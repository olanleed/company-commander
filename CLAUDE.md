# CLAUDE.md
このリポジトリで Claude / Claude Code が作業するときの **TDD とコード品質** ガイドラインです。  
（会話の冒頭で必ず読まれる前提なので、**短く・守りやすく・検証可能**なルールだけを書きます）

> 参照（存在するなら）: @README.md / @CONTRIBUTING.md / @docs/ / @package.json / @Makefile / @pyproject.toml など  
> ※このファイルに書いていない詳細ルールは `@docs/quality.md` のような別ファイルに切り出してインポートする

---

## 最重要ルール（毎回守る）
1. **探索 → 計画 → 実装**の順で進める（いきなり書き始めない）
2. **検証手段を必ず用意**する（テスト、再現手順、期待出力、スクショ比較など）
3. 変更は**小さく分ける**（1PR/1コミットの意図を明確に）
4. **TDD（Red-Green-Refactor）を基本**にする（例外は理由を説明）
5. **Flaky（不安定）なテストを増やさない**。増えそうなら設計から見直す
6. 既存のスタイル/設計に合わせる。新しい流儀の導入は最小限にし、必要なら根拠を書く

---

## 作業フロー（Claude が守る）
### 1) 探索（理解）
- 影響範囲を特定：該当コード、関連テスト、呼び出し元、契約（入出力・例外・型）
- 既存の失敗/再現があるなら、**まず再現に成功**する（ログ・スタックトレース・入力など）

### 2) 計画（短く具体的に）
- 変更点（箇条書き）
- 追加/更新するテスト（何を保証するか）
- 実行するコマンド（例：lint / typecheck / unit / integration / e2e）

### 3) 実装（TDD）
- 1ステップ = 1つの失敗理由（Red）→最小実装（Green）→整理（Refactor）
- 途中で設計が揺れたら、テストリストに戻って順番を調整する

### 4) 仕上げ（品質ゲート）
- リファクタリング（重複排除、命名、責務分割、例外/エラー経路）
- 静的解析・フォーマット・型・テストを通す
- 変更内容、検証結果、既知のリスクを短く報告する

---

## TDD ルール（Red-Green-Refactor）
- **テストリスト**を作る（箇条書きでOK）。次に書くテストを1つ選ぶ
- **Red**: まず失敗するテストを書く（「本当に落ちる」を確認）
- **Green**: そのテストを通す最小実装を書く（最短でOK。次で整える）
- **Refactor**: 仕様は変えずに構造を良くする（プロダクション/テスト両方）
- 仕様追加とリファクタリングを混ぜない（混ざるなら分割）

---

## テスト戦略（速いフィードバックを最優先）
### テストサイズ（Small / Medium / Large）
基本方針：**Small を厚く、Large は最小限**。遅い/不安定なテストに依存しない。

| Size | ネットワーク | DB | ファイル | 外部システム | マルチスレッド | sleep | 目安タイムアウト |
|---|---:|---:|---:|---:|---:|---:|---:|
| Small | No | No | No | No | No | No | 〜60s |
| Medium | localhost のみ | Yes | Yes | 非推奨 | Yes | Yes | 〜300s |
| Large | Yes | Yes | Yes | Yes | Yes | Yes | 900s+ |

- **Small**: 純粋ロジック中心。決定的・高速・隔離。ローカルで頻繁に回す
- **Medium**: コンポーネント境界・I/O を含む。契約（インタフェース）を保証
- **Large**: E2E/高忠実度。数は最小。**オーナー（責任者）と目的**を明確にする

### 良いテストの性質（チェックリスト）
- **Fast**: 開発の流れを止めない
- **Independent**: 実行順序に依存しない（並列実行を邪魔しない）
- **Repeatable**: 環境差で落ちない（決定的）
- **Self-validating**: 目視不要（pass/fail が明確）
- **Timely**: 実装直前に書く（テストが仕様を駆動する）

### Flaky を防ぐ（必須）
- 時刻・乱数・並列・ネットワーク依存は原則排除（必要なら固定/注入/疑似化）
- `sleep` で待たない：**状態ポーリング + タイムアウト**、イベント通知、フェイクタイマー等に置換
- 外部依存は「実物E2E」一択にしない：**契約テスト + fake/stub** を併用
- モックは最小限。**境界の契約**を壊しやすい“実装追従モック”を増やさない

---

## コード品質（読みやすさ・保守性）
### 設計・可読性（最優先）
- **読者最適（Optimize for the reader）**：未来の読者が迷わない命名と構造にする
- **局所推論（Local reasoning）**：呼び出し側だけで挙動が推測できる API/型/契約にする
- 1関数/1責務、過剰な抽象化を避ける（抽象化は“重複と変更点”が見えた後）
- コメントは “why（理由/制約/トレードオフ）” を書く。“what” はコードで表現する

### 変更に強い実装
- 重複を増やさない（同じロジックを複製しない）
- 既存のユーティリティ/パターンを先に探す（新規追加は最後）
- 失敗時の挙動（例外、戻り値、ログ）を明確にし、握りつぶさない
- 公開API/境界は破壊的変更を避ける。必要なら移行手順/互換層/段階的変更を用意する

---

## PR / レビュー（コードヘルス）
- PR は**小さく**、意図が1つになるよう分割する
- PR 説明に必ず書く：
  - 目的 / 背景
  - 変更点（箇条書き）
  - 追加・更新したテスト（何を保証するか）
  - 実行したコマンドと結果
  - 既知のリスク / TODO（あれば）
- “完璧さ”より **コードヘルスが改善しているか** を優先。ただし、品質を悪化させる変更は不可

---

## コマンド（プロジェクトに合わせて更新）
> Claude はまずリポジトリ内から正しいコマンドを特定する（README / package.json scripts / Makefile / CI 定義など）

- Lint: `TODO`
- Format: `TODO`
- Typecheck: `TODO`
- Unit tests (Small): `TODO`
- Integration tests (Medium): `TODO`
- E2E tests (Large): `TODO`

---

## Claude の報告フォーマット（毎回）
- 変更概要
- 追加/更新したテスト（狙い）
- 実行したコマンドと結果（貼れる範囲で）
- 懸念点 / 残タスク（あれば）
